<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<body
  class="bg-gray-900 font-sans text-gray-200 flex flex-col items-center justify-center min-h-screen p-4"
>
  <div class="max-w-4xl w-full bg-gray-800 rounded-lg shadow-xl p-6">
    <h2 class="text-4xl font-semibold mb-6 text-center text-white">
      Socket.IO Chat
    </h2>

    <ul
      id="messageList"
      class="bg-gray-700 p-4 rounded-lg shadow-lg overflow-y-auto h-80 mb-4 space-y-4"
    >
      <div class="typing" style="display: none"></div>
    </ul>

    <form
      onsubmit="handleMsgSend(event)"
      class="flex items-center justify-between w-full space-x-4 mt-4"
    >
      <input
        onchange="handleChange()"
        type="text"
        id="message"
        placeholder="Type your message..."
        class="flex-1 p-4 bg-gray-800 text-white rounded-lg h-16 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent"
      />
      <button
        type="submit"
        class="bg-yellow-500 text-white rounded-lg px-6 py-3 h-16 hover:bg-yellow-600 transition-colors duration-200"
      >
        Send
      </button>
    </form>
  </div>
</body>

<script>
  const messageList = document.querySelector("#messageList");
  const storedId = localStorage.getItem("socketId");

  const socket = io("http://localhost:4999", {
    query: {
      id: storedId || undefined,
    },
  });

  function handleChange() {
    socket.emit("typing");
  }
  function handleMsgSend(e) {
    e.preventDefault();
    let message = document.querySelector("#message");
    const msg = message.value.trim();
    console.log(msg);
    if (!msg) {
      alert("Cant send empty msg");
      return;
    }
    socket.emit("messageToServer", msg);
    message.value = "";
  }

  socket.on("connect", () => {
    const id = socket.id;
    const typing = document.querySelector(".typing");

    if (!storedId) {
      localStorage.setItem("socketId", id);
    }

    socket.on("user typing", (message) => {
      typing.innerHTML = `<span class="text-white p-3 rounded-lg max-w-3/4">${message}</span>`;
      typing.style.display = "block";
      messageList.scrollTop = messageList.scrollHeight;
    });

    socket.on("messageToClient", (userId, message, date1) => {
      const time = new Date(Date.now());

      console.log(time.toLocaleTimeString());
      console.log(date1);
      const li = document.createElement("li");
      const span = document.createElement("span");

      span.innerText = `${userId} : ${message}`;
      typing.style.display = "none";

      span.classList.add(
        "text-white",
        "p-3",
        "rounded-lg",
        "max-w-3/4",
        "break-words",
        "whitespace-pre-wrap"
      );
      li.classList.add(
        `${storedId === userId ? "bg-red-500" : "bg-blue-500"}`,
        "w-full",
        "mb-2",
        "flex",
        "justify-start",
        "px-2",
        "bg-blue-500"
      );
      li.appendChild(span);
      messageList.appendChild(li);
      messageList.scrollTop = messageList.scrollHeight;
    });
  });
</script>
